# Production Docker Compose - Fixed configuration
# Usage: ./scripts/prod.sh
#
# IMPORTANT: Do not modify these values - they are tied to existing production data volumes
# Volume: trading_analyst_prod_postgres_data_prod contains production database
#
# Frontend runs locally: cd frontend && VITE_API_PROXY_TARGET=http://localhost:8093 npm run dev -- --port 5177

name: trading_analyst_prod

services:
  postgres-prod:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: trading_analyst_prod
      POSTGRES_USER: trader
      POSTGRES_PASSWORD: localpass_prod
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5440:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trader -d trading_analyst_prod"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend-prod:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql+asyncpg://trader:localpass_prod@postgres-prod:5432/trading_analyst_prod
      ENVIRONMENT: production
      DEBUG: "false"
      LOG_LEVEL: WARNING
      PYTHONPATH: /app
      DOCKER_ENV: "true"
      # Broker configuration
      BROKER_TYPE: ${BROKER_TYPE:-mock}
      MARKET_DATA_PROVIDER: ${MARKET_DATA_PROVIDER:-yahoo}
      # Interactive Brokers settings
      IB_HOST: ${IB_HOST:-host.docker.internal}
      IB_PORT: ${IB_PORT:-7497}
      IB_CLIENT_ID: ${IB_CLIENT_ID:-1}
      IB_DATA_CLIENT_ID: ${IB_DATA_CLIENT_ID:-99}
      IB_ACCOUNT: ${IB_ACCOUNT:-}
      IB_CONNECTION_TIMEOUT: ${IB_CONNECTION_TIMEOUT:-30}
      IB_ORDER_TIMEOUT: ${IB_ORDER_TIMEOUT:-60}
    volumes:
      - ./backend:/app
    ports:
      - "8093:8000"
    depends_on:
      postgres-prod:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    command: uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

volumes:
  postgres_data_prod:
    external: true
    name: trading_analyst_prod_postgres_data_prod
